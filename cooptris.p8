pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- cooptris
-- shillysit
board_x=3
board_y=3
board_width=13
board_height=23
block_size=5
start_fall=30
fall_rate=5
min_fall_duration=1
player_count=2
mark_duration=7
bg_color=7
empty_color=6
mark_color=10
player_colors={{8,2},{11,3}}
player_start={{8,0},{1,0}}
pieces={}
pieces[1]={{x=0,y=0},{x=-1,y=0},{x=1,y=0},{x=2,y=0}} -- stick
pieces[2]={{x=-1,y=1},{x=0,y=1},{x=1,y=1},{x=1,y=0}} -- l
pieces[3]={{x=-1,y=0},{x=0,y=0},{x=1,y=0},{x=1,y=1}} -- l reverse
pieces[4]={{x=0,y=0},{x=-1,y=0},{x=0,y=1},{x=1,y=1}} -- z
pieces[5]={{x=0,y=0},{x=-1,y=1},{x=0,y=1},{x=1,y=0}} -- z reverse
pieces[6]={{x=0,y=0},{x=1,y=0},{x=1,y=1},{x=0,y=1}} -- block

function _init()
	printh("game started")

	blocks={}
	for i=0, board_width do
		for j=0, board_height do
			blocks[i..","..j]=empty_color
		end
	end
	
	players={}
	for i=1, player_count do
		add(players,make_player(i))
	end
	
	lines_marked=false
	mark_timer=0
	lines_cleared=0
	hold={}
	speed=start_fall;
	fall_duration=start_fall
	fall_timer=fall_duration
	isgameover=false
end

function _update()
	speed=max(min_fall_duration,start_fall-(fall_rate*lines_cleared))
	
	if lines_marked then
		if mark_timer>0 then
			mark_timer-=1
		else
			-- clear marked lines
			for p in all(players) do
				remove_player_piece(p)
			end
			for i=0,board_height do
				if blocks["0,"..i]==mark_color then
					remove_line(i)
				end
			end
			for p in all(players) do
				add_player_piece(p,1)
			end
			lines_marked=false
		end
	else
		if isgameover then
			if btn(4) and btn(5) then
				_init()
				sfx(5)
			end
		else
			-- fall timer
			local fall=false
			if fall_timer > 0 then
				fall_timer-=1
			else
				fall=true
				fall_timer=speed
			end
		
			-- update players
			for p in all(players) do
				remove_player_piece(p)
				update_player(p,fall)
				add_player_piece(p,1)
			end

			-- clear complete lines
			mark_lines()

			-- check if game over
			for i=0,board_width do
				for p in all(players) do
					if blocks[i..",0"]==player_colors[p.id][2] then
						isgameover = true
						sfx(4)
					end
				end
			end

			-- give players new pieces
			for p in all(players) do
				if p.piece==nil then
					p.piece=make_random_piece()
				end
			end
		end
	end
end

function _draw()
	cls(bg_color)
	
	-- draw blocks
	for i=0, board_width do
		for j=0, board_height do
			local c=blocks[i..","..j]
			local x=(i*block_size)+1+board_x
			local y=(j*block_size)+1+board_y
			rectfill(x,y,x+block_size-2,y+block_size-2,c)
		end
	end

	-- hud
	print("hold",90,5,0)
	for b in all(hold) do
		local x=(b.x*block_size)+96
		local y=(b.y*block_size)+20
		rectfill(x,y,x+block_size-2,y+block_size-2,0)
	end

	print("lines",90,50,0)
	print(tostr(lines_cleared),90,56,0)

	print("speed",90,70,0)
	print(tostr(speed),90,76,0)

	if (isgameover) then
		rectfill(16,48,112,80,0)
		print("game over",47,54,6)
		print("‚ùé+üÖæÔ∏è to restart",32,68,6)
	end
end

function make_player(id)
	local p={}
	p.x=player_start[id][1]
	p.y=player_start[id][2]
	p.id=id
	p.piece=make_random_piece()
	return p
end

function remove_player_piece(p)
	if p.piece==nil then
		return
	end

	for b in all(p.piece) do
		local x=p.x+b.x
		local y=p.y+b.y
		blocks[x..","..y]=empty_color
	end
end

function add_player_piece(p,i)
	if p.piece==nil then
		return
	end

	for b in all(p.piece) do
		local x=p.x+b.x
		local y=p.y+b.y
		local c=player_colors[p.id]
		blocks[x..","..y]=c[i]
	end
end

function collide_board(p,px,py)
	for b in all(p.piece) do
		local x=px+b.x
		local y=py+b.y
		local c=blocks[x..","..y]
		if x<0 then
			return true
		elseif x>board_width then
			return true
		elseif y<0 then
			return true
		elseif y>board_height then
			return true
		end
	end
end

function collide_player(p,px,py,i)
	for b in all(p.piece) do
		local x=px+b.x
		local y=py+b.y
		local c=blocks[x..","..y]
		for p in all(players) do
			local pc=player_colors[p.id]
			if blocks[x..","..y]==pc[i] then
				return true
			end
		end
	end
	return false
end

function collide_all(p,px,py)
	if collide_board(p,px,py) then
		return true
	end

	if collide_player(p,px,py,1) then
		return true
	end

	if collide_player(p,px,py,2) then
		return true
	end

	return false
end

function lock_piece(p)
	add_player_piece(p,2)
	p.x=player_start[p.id][1]
	p.y=player_start[p.id][2]
	p.piece=nil
	sfx(2)
end

function update_player(p,fall)
	if p.piece==nill then
		return
	end

	local id=p.id-1

 	-- falling
	if fall or btnp(3,id) then
		if not collide_player(p,p.x,p.y+1,1) then
			if collide_board(p,p.x,p.y+1) or collide_player(p,p.x,p.y+1,2) then
				lock_piece(p)
			else
				p.y+=1
			end
		end
	end
	
	-- input
	if btnp(3,id) then
		sfx(3)
	elseif btnp(0,id) then
		if not collide_all(p,p.x-1,p.y) then
			p.x-=1
			sfx(3)
		end
	elseif btnp(1,id) then
		if not collide_all(p,p.x+1,p.y) then
			p.x+=1
			sfx(3)
		end
	elseif btnp(4,id) then
		while not collide_all(p,p.x,p.y+1) do
			p.y+=1
		end
		if collide_board(p,p.x,p.y+1) or collide_player(p,p.x,p.y+1,2) then
			lock_piece(p)
		end
	elseif btnp(2,id) then
		rotate_piece(p)
	elseif btnp(5,id) then
		swap_piece(p)
		sfx(1)
	end
end

function swap_piece(p)
	if #hold==0 then
		hold=p.piece
		p.piece=make_random_piece()
	else
		local oldhold = copy_piece(hold)
		hold=p.piece
		p.piece=oldhold
	end
end

function make_random_piece()
	local template=pieces[flr(rnd(#pieces))+1]
	return copy_piece(template)
end

function copy_piece(original)
	local copy={}
	for b in all(original) do
		add(copy,{x=b.x,y=b.y})
	end
	return copy
end

function rotate_piece(p)
	local old=copy_piece(p.piece)
	for b in all(p.piece) do
		local oldx = b.x
		b.x=-b.y
		b.y=oldx
	end
	if collide_all(p,p.x,p.y) then
		p.piece=old
	else
		sfx(0)
	end
end

function mark_lines()
	for p in all(players) do
		remove_player_piece(p)
	end

 	for i=0,board_height do
		if is_line(i) then
			mark_line(i)
			lines_marked=true;
			mark_timer=mark_duration
			lines_cleared+=1
		end
	end

	for p in all(players) do
		add_player_piece(p,1)
	end
end

function mark_line(row)
	for i=0,board_width do
		blocks[i..","..row]=mark_color
	end
end

function remove_line(row)
	for i=row,0,-1 do
		for j=0,board_width do
			if i>0 then
				local prev=i-1
				blocks[j..","..i]=blocks[j..","..prev]
			else
				blocks[j..","..i]=empty_color
			end
		end
	end
end

function is_line(row)
	for i=0,board_width do
		c=blocks[i..","..row]
		if c==empty_color then
			return false
		end
		
		for p in all(players) do
			local pc=player_colors[p.id]
			if c==pc[1] then
				return false
			end
		end
	end
	return true
end
__label__
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777707077007077700777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777707070707077707077777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777700070707077707077777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777707070707077707077777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777707070077000700077777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
7777666676666766667666676666766667bbbb7bbbb7666676666766667666676666766667777777777777777777777777777777777777777777777777777777
7777666676666766667666676666766667bbbb7bbbb7666676666766667666676666766667777777777777777777777700007777777777777777777777777777
7777666676666766667666676666766667bbbb7bbbb7666676666766667666676666766667777777777777777777777700007777777777777777777777777777
7777666676666766667666676666766667bbbb7bbbb7666676666766667666676666766667777777777777777777777700007777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777700007777777777777777777777777777
77776666766667666676666766667bbbb7bbbb766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667bbbb7bbbb766667666676666766667666676666766667777777777777777777777700007777777777777777777777777777
77776666766667666676666766667bbbb7bbbb766667666676666766667666676666766667777777777777777777777700007777777777777777777777777777
77776666766667666676666766667bbbb7bbbb766667666676666766667666676666766667777777777777777777777700007777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777700007777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777770000700007777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777770000700007777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777770000700007777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777770000700007777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777707770007007700077007777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777707777077070707770777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777707777077070700770007777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777707777077070707777707777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777700070007070700070077777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777700077777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777707077777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777707077777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777707077777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777700077777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667666676666766667666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77776666766667333373333733337666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667333373333733337666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667333373333733337666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666766667333373333733337666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77776666733337333376666733337666676666766667666676666766667666676666766667777777777777777777777777777777777777777777777777777777
77776666733337333376666733337666676666766667666676666766667666676666766667777777777777777770070007000700070077777777777777777777
77776666733337333376666733337666676666766667666676666766667666676666766667777777777777777707770707077707770707777777777777777777
77776666733337333376666733337666676666766667666676666766667666676666766667777777777777777700070007007700770707777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777070777077707770707777777777777777777
77776666733337333376666766667666676666766667666676666766667666676666722227777777777777777700770777000700070007777777777777777777
77776666733337333376666766667666676666766667666676666766667666676666722227777777777777777777777777777777777777777777777777777777
77776666733337333376666766667666676666766667666676666766667666676666722227777777777777777700070007777777777777777777777777777777
77776666733337333376666766667666676666766667666676666766667666676666722227777777777777777777070707777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777770070707777777777777777777777777777777
77776666733337333376666766667666676666766667666676666766667666676666722227777777777777777777070707777777777777777777777777777777
77776666733337333376666766667666676666766667666676666766667666676666722227777777777777777700070007777777777777777777777777777777
77776666733337333376666766667666676666766667666676666766667666676666722227777777777777777777777777777777777777777777777777777777
77776666733337333376666766667666676666766667666676666766667666676666722227777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77776666733337333376666766667666676666766667666676666766667666672222722227777777777777777777777777777777777777777777777777777777
77776666733337333376666766667666676666766667666676666766667666672222722227777777777777777777777777777777777777777777777777777777
77776666733337333376666766667666676666766667666676666766667666672222722227777777777777777777777777777777777777777777777777777777
77776666733337333376666766667666676666766667666676666766667666672222722227777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77773333733337666676666766667666676666766667666676666766667666672222722227777777777777777777777777777777777777777777777777777777
77773333733337666676666766667666676666766667666676666766667666672222722227777777777777777777777777777777777777777777777777777777
77773333733337666676666766667666676666766667666676666766667666672222722227777777777777777777777777777777777777777777777777777777
77773333733337666676666766667666676666766667666676666766667666672222722227777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77776666733337333373333766667666676666766667666676666788887888872222722227777777777777777777777777777777777777777777777777777777
77776666733337333373333766667666676666766667666676666788887888872222722227777777777777777777777777777777777777777777777777777777
77776666733337333373333766667666676666766667666676666788887888872222722227777777777777777777777777777777777777777777777777777777
77776666733337333373333766667666676666766667666676666788887888872222722227777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77776666733337333373333766667666676666766667666678888788887666672222722227777777777777777777777777777777777777777777777777777777
77776666733337333373333766667666676666766667666678888788887666672222722227777777777777777777777777777777777777777777777777777777
77776666733337333373333766667666676666766667666678888788887666672222722227777777777777777777777777777777777777777777777777777777
77776666733337333373333766667666676666766667666678888788887666672222722227777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77773333733337333373333733337333376666766667666676666766667666672222766667777777777777777777777777777777777777777777777777777777
77773333733337333373333733337333376666766667666676666766667666672222766667777777777777777777777777777777777777777777777777777777
77773333733337333373333733337333376666766667666676666766667666672222766667777777777777777777777777777777777777777777777777777777
77773333733337333373333733337333376666766667666676666766667666672222766667777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77773333766667333373333733337333376666766667666676666722227222272222766667777777777777777777777777777777777777777777777777777777
77773333766667333373333733337333376666766667666676666722227222272222766667777777777777777777777777777777777777777777777777777777
77773333766667333373333733337333376666766667666676666722227222272222766667777777777777777777777777777777777777777777777777777777
77773333766667333373333733337333376666766667666676666722227222272222766667777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77773333733337333373333733337666676666766667666672222722227222272222722227777777777777777777777777777777777777777777777777777777
77773333733337333373333733337666676666766667666672222722227222272222722227777777777777777777777777777777777777777777777777777777
77773333733337333373333733337666676666766667666672222722227222272222722227777777777777777777777777777777777777777777777777777777
77773333733337333373333733337666676666766667666672222722227222272222722227777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77773333733337333373333766667222272222722227222272222722227222272222722227777777777777777777777777777777777777777777777777777777
77773333733337333373333766667222272222722227222272222722227222272222722227777777777777777777777777777777777777777777777777777777
77773333733337333373333766667222272222722227222272222722227222272222722227777777777777777777777777777777777777777777777777777777
77773333733337333373333766667222272222722227222272222722227222272222722227777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777

__sfx__
00010000090500a0500b0500b0501b050180501605014050110500e0500b05007050040500205006050050501405016050190501b0501d0501e05020050040000400004000040000400004000030000300000000
00010000320502c05025050210501c050170500e0500c0500905008050100500e0500c0500b050090500705006050050500305003050020500205002050030500405005050070500000000000000000000000000
00010000181501b15019150151501215011150101500d1500d1500b15009150081500815007150051500515004150051501e10022100001000010000100001000010000100001000010000100001000010000100
000300001303001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000800000e2500e2500b2500b250032500525001250022500225002250022500225002240022300120001200012001b2001c2001d200202000020000200000000000000000000000000000000000000000000000
000300003c7503575033740357000270032740367503d7703d75038700387002c700387003a7003b7003c7003d700307003a7003e700347003970033700357003770029700047000070000700007000070000700
